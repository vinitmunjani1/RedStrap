{% extends 'core/base.html' %}

{% block title %}{{ account.username }} Analytics - REDSTRAP{% endblock %}

{% block content %}
<h1>@{{ account.username }} - {% if is_reels %}Reels{% else %}Posts{% endif %} Analytics</h1>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <h5>Total {% if is_reels %}Reels{% else %}Posts{% endif %}</h5>
            <h2>{{ total_posts }}</h2>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <h5>Total Likes</h5>
            <h2>{{ total_likes|floatformat:0 }}</h2>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <h5>Total Comments</h5>
            <h2>{{ total_comments|floatformat:0 }}</h2>
        </div>
    </div>
    {% if is_reels %}
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <h5>Total Plays</h5>
            <h2>{{ total_plays|floatformat:0 }}</h2>
        </div>
    </div>
    {% endif %}
</div>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted mb-2">Average Likes</h5>
                <h3 class="mb-0">{{ avg_likes|floatformat:1 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted mb-2">Average Comments</h5>
                <h3 class="mb-0">{{ avg_comments|floatformat:1 }}</h3>
            </div>
        </div>
    </div>
    {% if is_reels %}
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted mb-2">Average Views</h5>
                <h3 class="mb-0">{{ avg_plays|floatformat:1 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted mb-2">Avg Views/Hour</h5>
                <h3 class="mb-0">{{ avg_plays_per_hour|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted mb-2">Avg Likes/Hour</h5>
                <h3 class="mb-0">{{ avg_likes_per_hour|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted mb-2">Avg Comments/Hour</h5>
                <h3 class="mb-0">{{ avg_comments_per_hour|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if not is_reels %}
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-bar-chart"></i> Average Likes per Hour</h5>
                <div style="position: relative; height: 300px;">
                    <canvas id="avgLikesPerHourChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-bar-chart"></i> Posts per Day</h5>
                <div style="position: relative; height: 300px;">
                    <canvas id="postsPerDayChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-bar-chart"></i> Average Views per Hour</h5>
                <div style="position: relative; height: 300px;">
                    <canvas id="avgPlaysPerHourChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-bar-chart"></i> Reels per Day</h5>
                <div style="position: relative; height: 300px;">
                    <canvas id="reelsPerDayChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Chart.js configuration for dark theme
    Chart.defaults.color = '#cbd5e1';
    Chart.defaults.borderColor = '#334155';
    Chart.defaults.backgroundColor = 'rgba(99, 102, 241, 0.5)';

{% if not is_reels %}
    // Average Likes per Hour Histogram
    const avgLikesCtx = document.getElementById('avgLikesPerHourChart');
    if (avgLikesCtx) {
        const chartLabels = {{ chart_labels|safe }};
        const avgLikesData = {{ avg_likes_per_hour_data|safe }};
        
        new Chart(avgLikesCtx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Avg Likes/Hour',
                    data: avgLikesData,
                    backgroundColor: 'rgba(99, 102, 241, 0.6)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: '#334155',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: '#334155'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#94a3b8',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: '#334155'
                        }
                    }
                }
            }
        });
    }

    // Posts per Day Histogram
    const postsPerDayCtx = document.getElementById('postsPerDayChart');
    if (postsPerDayCtx) {
        const chartLabels = {{ chart_labels|safe }};
        const postsData = {{ posts_per_day_data|safe }};
        
        new Chart(postsPerDayCtx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Posts Count',
                    data: postsData,
                    backgroundColor: 'rgba(6, 182, 212, 0.6)',
                    borderColor: 'rgba(6, 182, 212, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: '#334155',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#94a3b8',
                            stepSize: 1
                        },
                        grid: {
                            color: '#334155'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#94a3b8',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: '#334155'
                        }
                    }
                }
            }
        });
    }
{% endif %}

{% if is_reels %}
    // Average Views per Hour Histogram for Reels
    const avgPlaysCtx = document.getElementById('avgPlaysPerHourChart');
    if (avgPlaysCtx) {
        const chartLabels = {{ chart_labels|safe }};
        const avgPlaysData = {{ avg_plays_per_hour_data|safe }};
        
        new Chart(avgPlaysCtx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Avg Views/Hour',
                    data: avgPlaysData,
                    backgroundColor: 'rgba(139, 92, 246, 0.6)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: '#334155',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: '#334155'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#94a3b8',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: '#334155'
                        }
                    }
                }
            }
        });
    }

    // Reels per Day Histogram
    const reelsPerDayCtx = document.getElementById('reelsPerDayChart');
    if (reelsPerDayCtx) {
        const chartLabels = {{ chart_labels|safe }};
        const reelsData = {{ reels_per_day_data|safe }};
        
        new Chart(reelsPerDayCtx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Reels Count',
                    data: reelsData,
                    backgroundColor: 'rgba(6, 182, 212, 0.6)',
                    borderColor: 'rgba(6, 182, 212, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: '#334155',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#94a3b8',
                            stepSize: 1
                        },
                        grid: {
                            color: '#334155'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#94a3b8',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: '#334155'
                        }
                    }
                }
            }
        });
    }
{% endif %}
</script>

<h3 class="mb-4"><i class="bi bi-trophy-fill"></i> Top {% if is_reels %}5 Most Played Reels{% else %}10 Posts by Likes{% endif %}</h3>
<div class="row">
    {% for post in top_posts %}
        <div class="col-md-6 col-lg-4 mb-4">
            <a href="{% url 'instagram_post_detail' post.id %}" class="text-decoration-none">
                <div class="card post-card h-100" style="position: relative; overflow: hidden; cursor: pointer;">
                    <!-- Ranking Badge -->
                    <div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                        {% if forloop.counter == 1 %}
                            <span class="badge" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; font-size: 0.9rem; padding: 0.5rem 0.75rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                <i class="bi bi-trophy-fill"></i> #1
                            </span>
                        {% elif forloop.counter == 2 %}
                            <span class="badge" style="background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); color: #000; font-size: 0.9rem; padding: 0.5rem 0.75rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                <i class="bi bi-trophy-fill"></i> #2
                            </span>
                        {% elif forloop.counter == 3 %}
                            <span class="badge" style="background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); color: #fff; font-size: 0.9rem; padding: 0.5rem 0.75rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                <i class="bi bi-trophy-fill"></i> #3
                            </span>
                        {% else %}
                            <span class="badge bg-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.6rem; font-weight: 600;">
                                #{{ forloop.counter }}
                            </span>
                        {% endif %}
                    </div>
                    
                    <!-- Post Type Badge -->
                    {% if post.is_reel %}
                        <div class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
                            <span class="badge bg-danger" style="font-size: 0.75rem; padding: 0.35rem 0.5rem;">
                                <i class="bi bi-play-fill"></i> Reel
                            </span>
                        </div>
                    {% elif post.is_video %}
                        <div class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
                            <span class="badge bg-primary" style="font-size: 0.75rem; padding: 0.35rem 0.5rem;">
                                <i class="bi bi-camera-video"></i> Video
                            </span>
                        </div>
                    {% endif %}
                    
                    <!-- Image with Overlay on Hover -->
                    <div style="position: relative; overflow: hidden; height: 250px; background: var(--bg-tertiary);">
                        {% if post.image_url %}
                            <img src="{{ post.image_url }}" class="card-img-top post-image" alt="Post image" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;">
                        {% else %}
                            <div class="d-flex align-items-center justify-content-center h-100" style="background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);">
                                <i class="bi bi-image" style="font-size: 3rem; color: var(--text-muted);"></i>
                            </div>
                        {% endif %}
                        <!-- Hover Overlay -->
                        <div class="post-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(99, 102, 241, 0.9); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease;">
                            <span style="color: white; font-weight: 600; font-size: 1.1rem;">
                                <i class="bi bi-eye"></i> View Details
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <!-- Caption -->
                        <p class="card-text small mb-3" style="color: var(--text-secondary); min-height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ post.caption|truncatewords:20|default:"No caption" }}
                        </p>
                        
                        <!-- Stats Grid -->
                        <div class="mt-auto">
                            <div class="row g-2 text-center">
                                <div class="col-4">
                                    <div class="stat-item" style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                        <div style="color: #ef4444; font-size: 1.1rem; font-weight: 700;">
                                            <i class="bi bi-heart-fill"></i> {{ post.like_count|floatformat:0 }}
                                        </div>
                                        <small style="color: var(--text-muted); font-size: 0.7rem;">Likes</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item" style="padding: 0.5rem; background: rgba(6, 182, 212, 0.1); border-radius: 8px; border: 1px solid rgba(6, 182, 212, 0.2);">
                                        <div style="color: #06b6d4; font-size: 1.1rem; font-weight: 700;">
                                            <i class="bi bi-chat-fill"></i> {{ post.comment_count|floatformat:0 }}
                                        </div>
                                        <small style="color: var(--text-muted); font-size: 0.7rem;">Comments</small>
                                    </div>
                                </div>
                                {% if is_reels %}
                                <div class="col-4">
                                    <div class="stat-item" style="padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                                        <div style="color: #8b5cf6; font-size: 1.1rem; font-weight: 700;">
                                            <i class="bi bi-play-fill"></i> {{ post.play_count|default:0|floatformat:0 }}
                                        </div>
                                        <small style="color: var(--text-muted); font-size: 0.7rem;">Plays</small>
                                    </div>
                                </div>
                                {% else %}
                                <div class="col-4">
                                    <div class="stat-item" style="padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                        <div style="color: #10b981; font-size: 1.1rem; font-weight: 700;">
                                            <i class="bi bi-graph-up-arrow"></i> {{ post.like_count|add:post.comment_count|floatformat:0 }}
                                        </div>
                                        <small style="color: var(--text-muted); font-size: 0.7rem;">Total</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Date -->
                            <div class="mt-2 text-center">
                                <small style="color: var(--text-muted);">
                                    <i class="bi bi-calendar3"></i> {{ post.taken_at|date:"M d, Y" }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    {% empty %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-info-circle" style="font-size: 3rem; color: var(--text-muted);"></i>
                    <p class="mt-3 text-muted">No {% if is_reels %}reels{% else %}posts{% endif %} found.</p>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<style>
    .post-card {
        transition: all 0.3s ease;
    }
    
    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
        border-color: var(--accent-primary) !important;
    }
    
    .post-card:hover .post-image {
        transform: scale(1.05);
    }
    
    .post-card:hover .post-overlay {
        opacity: 1;
    }
    
    .stat-item {
        transition: all 0.2s ease;
    }
    
    .post-card:hover .stat-item {
        transform: scale(1.05);
    }
</style>
{% endblock %}
